;----------------------------------------------
;Global Config
;----------------------------------------------

;Coordinates
global attack_button_X := 525
global attack_button_Y := 575

global join_confirm_X := 500
global join_confirm_Y := 820

global battle_end_X := 375
global battle_end_Y := 415

global first_summon_X := 180
global first_summon_Y := 570

global ready_button_X := 590
global ready_button_Y := 856

global select_party_button_X := 370
global select_party_button_Y := 1020

global first_favorite_X := 368
global first_favorite_Y := 760

global vee_dialog_X := 324
global vee_dialog_Y := 584

global use_half_elixir_X := 500
global use_half_elixir_Y := 750

global use_item_ok_X := 373
global use_item_ok_Y := 745

global next_button_X := 608
global next_button_Y := 578

global wind_summon_X := 373
global wind_summon_Y := 402

global misc_summon_X := 604
global misc_summon_Y := 402

global auto_button_X := 128 
global auto_button_Y := 609

global go_button_X := 544
global go_button_Y := 592

global favorites_button_X := 130
global favorites_button_Y := 520

global story_X := 341
global story_2_Y := 600
global story_3_Y := 674
global story_4_Y := 750

global story_ok_X := 500
global story_ok_Y := 780

global story_skip_X := 200
global story_skip_Y := 920

global story_skip_ok_X := 490
global story_skip_ok_Y := 600

global battle_menu_X := 615
global battle_menu_Y := 110

global battle_retreat_X := 500
global battle_retreat_Y := 760

global battle_retreat_confirm_X := 500
global battle_retreat_confirm_Y := 520

global poker_button_left_X := 235
global poker_button_right_X := 380
global poker_button_Y := 630


;Vmate skill offsets (defunct)
global skillX = 90
global skillXOffset = 25
global skillCharOffset = 103
global skillY = 860

;URL Strings
global ChromeBrowsers := "Chrome_WidgetWin_0,Chrome_WidgetWin_1"
global searchPoker := "#casino/game/poker"
global searchMypage := "#mypage"
global searchQuest := "#quest"
global searchQuestExtra := "#quest/extra"
global searchCoop := "#coopraid"
global searchCoopJoin := "#coopraid/offer"
global searchCoopRoom := "#coopraid/room"
global searchBattle := "#raid"
global searchStage := "stage"
global searchSelectSummon := "supporter"
global searchResults := "result"
global searchScene := "scene"
global searchGuildWars := "teamraid024"

global coopHomeURL := "http://game.granbluefantasy.jp/#coopraid"
global coopJoinURL := "http://game.granbluefantasy.jp/#coopraid/offer"
global questURL := "http://game.granbluefantasy.jp/#quest"
global guildWarsURL := "http://game.granbluefantasy.jp/#event/teamraid024"
global rabbitURL:= "http://game.granbluefantasy.jp/#quest/supporter/713431/0"


global GBF_winHeight := 1080
global GBF_winWidth := 700

;----------Search Images------------;
global image_path := "image/"

global attack_button := "attack_button.png"
global attack_button_2 := "2_attack_button.png"

global wind_icon := "wind_icon.png"
global wind_icon_selected := "wind_icon_selected.png"
global misc_icon := "misc_icon.png"
global misc_icon_selected := "misc_icon_selected.png"
global fire_icon := "fire_icon.png"
global fire_icon_selected := "fire_icon_selected.png"

global use_skill := "use_skill.png"

global select_party_auto_select := "select_party_auto_select.png"
global select_party_auto_select_2 := "2_select_party_auto_select.png"

global retreat_ok := "retreat_ok.png"

global select_support := "select_support.png"
global select_support_2 := "2_select_support.png"

global ready_start := "ready_to_start.png"
global ready_start_2 := "2_ready_to_start.png"

global wait_quest_start := "wait_quest_start.png"
global wait_quest_start_2 := "2_wait_quest_start.png"

global coopjoin_refresh := "coopjoin_refresh.png"
global coopjoin_refresh_2 := "2_coopjoin_refresh.png"

global coopjoin_room := "coopjoin_room.png"
global coopjoin_room_2 := "2_coopjoin_room.png"

global coopjoin_join_header := "coopjoin_join.png"
global coopjoin_join_header_2 := "2_coopjoin_join.png"

global favorites_button := "favorites_button.png"

global featured_button := "featured_button.png"

global not_enough_ap := "not_enough_ap.png"

global use_item := "use_item.png"

global view_story := "view_story.png"

global story_summary := "story_summary.png"

global mole_icon := "mole.png"

global battle_bosses := "battle_bosses.png"

global VH_Eye := "VH_Eye.png"

;----------Poker Images------------;
global poker_image_path := "poker_image/"
global deal_button := "deal_button.png"
global ok_button := "ok_button.png"
global start_button := "start_button.png"
global high_button := "high_button.png"
global low_button := "low_button.png"
global no_button := "no_button.png"
global yes_button := "yes_button.png"

global 02c := "2c.png"
global 02d := "2d.png"
global 02h := "2h.png"
global 02s := "2s.png"

global 03c := "3c.png"
global 03d := "3d.png"
global 03h := "3h.png"
global 03s := "3s.png"

global 04c := "4c.png"
global 04d := "4d.png"
global 04h := "4h.png"
global 04s := "4s.png"

global 05c := "5c.png"
global 05d := "5d.png"
global 05h := "5h.png"
global 05s := "5s.png"

global 06c := "6c.png"
global 06d := "6d.png"
global 06h := "6h.png"
global 06s := "6s.png"

global 07c := "7c.png"
global 07d := "7d.png"
global 07h := "7h.png"
global 07s := "7s.png"

global 08c := "8c.png"
global 08d := "8d.png"
global 08h := "8h.png"
global 08s := "8s.png"

global 09c := "9c.png"
global 09d := "9d.png"
global 09h := "9h.png"
global 09s := "9s.png"

global 10c := "10c.png"
global 10d := "10d.png"
global 10h := "10h.png"
global 10s := "10s.png"

global 11c := "11c.png"
global 11d := "11d.png"
global 11h := "11h.png"
global 11s := "11s.png"

global 12c := "12c.png"
global 12d := "12d.png"
global 12h := "12h.png"
global 12s := "12s.png"

global 13c := "13c.png"
global 13d := "13d.png"
global 13h := "13h.png"
global 13s := "13s.png"

global 14c := "14c.png"
global 14d := "14d.png"
global 14h := "14h.png"
global 14s := "14s.png"

global Xx := "Xx.png"

global keepCard_Y1 := 375
global keepCard_Y2 := 485

global keepCard1_X1 := 100
global keepCard1_X2 := 180

global keepCard2_X1 := 185
global keepCard2_X2 := 260

global keepCard3_X1 := 265
global keepCard3_X2 := 345

global keepCard4_X1 := 350
global keepCard4_X2 := 430

global keepCard5_X1 := 435
global keepCard5_X2 := 515


;Time intervals
global default_button_delay := 500
global long_delay := 5000
global post_ready_button_delay := 3000
global post_attack_button_delay := 5000

global kill_time := 10000
global short_interval := 500
global default_interval := 1000
global medium_interval := 3000
global globalTimeoutMax := 1000

;Configs
global roomJoinClicks := 5
global clickVariance := 20
global clickVarianceSmall := 6
global waitImageTimeoutMax := 10
global waitCoopHomeMax := 7
global waitResultMax := 5
global cardSearchLoops := 10



;----------------------------------------------
;ImageSearch wrappers
;----------------------------------------------

ImageSearchWrapper(byref searchResultX, byref searchResultY, imageFileName)
{
	searchResultX := 0
	searchResultY := 0
	
	ImageSearch, searchResultX, searchResultY, 0, 0, GBF_winWidth, GBF_winHeight, %  image_path . imageFileName
	
	if ErrorLevel = 2
	{
		updateLog("ImageSearch could not be completed")
		return false
	}
	else if ErrorLevel = 1
	{
		updateLog(imageFileName . " was not found.")
		return false
	}
	else 
	{
		updateLog(imageFileNAme . " found at: " . searchResultX . " , " . searchResultY)
		return true
	}
}

ImageSearchWrapperPoker(byref searchResultX, byref searchResultY, imageFileName, X1, Y1, X2, Y2)
{
	searchResultX := 0
	searchResultY := 0
	
	imagePath = %poker_image_path%%imageFileName%
	ImageSearch, searchResultX, searchResultY, X1, Y1, X2, Y2, *20 %imagePath%
	
	if ErrorLevel = 2
	{
		updateLog("ImageSearch could not be completed")
		return false
	}
	else if ErrorLevel = 1
	{
		updateLog(imageFileName . " was not found.")
		return false
	}
	else 
	{
		updateLog(imageFileNAme . " found at: " . searchResultX . " , " . searchResultY)
		return true
	}
}

MultiImageSearch(byref searchResultX, byref searchResultY, imageFileArray)
{
	searchResultX := 0
	searchResultY := 0

	for index, imageFileName in imageFileArray
	{
		;updateLog("Searching " . imageFileName)
		if ImageSearchWrapper(singleSearchX, singleSearchY, imageFileName)
		{
			searchResultX := singleSearchX
			searchResultY := singleSearchY
			return imageFileName
		}
	}
	return "Not Found"
}

MultiImageSearchPoker(byref searchResultX, byref searchResultY, imageFileArray, X1, Y1, X2, Y2)
{
	searchResultX := 0
	searchResultY := 0

	for index, imageFileName in imageFileArray
	{
		;updateLog("Searching " . imageFileName)
		if ImageSearchWrapperPoker(singleSearchX, singleSearchY, imageFileName, X1, Y1, X2, Y2)
		{
			searchResultX := singleSearchX
			searchResultY := singleSearchY
			return imageFileName
		}
	}
	return "Not Found"
}


WaitForImage(byref searchResultX, byref searchResultY, imageFileName)
{
	searchResultX := 0
	searchResultY := 0
	waitImageTimeout := 0
		
	updateLog("Waiting for image: " . imageFileName)
	Loop
	{
		if waitImageTimeout >= maxWaitImageTimeout
		{
			updateLog("Image timeout reached.")
			waitImageTimeout := 0
			return false
		}
		if ImageSearchWrapper(instanceSearchX, instanceSearchY, imageFileName)
		{
			updateLog(imageFileName . " found.")
			
			searchResultX := instanceSearchX
			searchResultY := instanceSearchY
			return true
		}
		else
		{
			waitImageTimeout := waitImageTimeout + 1
		}
	}
	return false
}

MultiWaitForImage(byref searchResultX, byref searchResultY, imageFileArray)
{
	searchResultX := 0
	searchResultY := 0
	waitImageTimeout := 0
		
	updateLog("Waiting for image: " . imageFileName)
	Loop
	{
		if waitImageTimeout >= maxWaitImageTimeout
		{
			updateLog("Image timeout reached.")
			waitImageTimeout := 0
			return false
		}

		searchResult := MultiImageSearch(instanceSearchX, instanceSearchY, imageFileArray)
		
		for index, imageFileName in imageFileArray
		{
			if searchResult = %imageFileName%
			{
				updateLog(imageFileName . " found.")
				
				searchResultX := instanceSearchX
				searchResultY := instanceSearchY
				return imageFileName
			}
		}
		waitImageTimeout := waitImageTimeout + 1
	}
	return false
}

;----------------------------------------------
;Utilities
;----------------------------------------------

updateLog(LogString)
{
	global Logbox
	FormatTime, currentTime,, hh:mm:ss
	rownumber := LV_Add("", currentTime, LogString) 
	LV_Modify(rownumber, "Vis") 
}

ResizeWin(Width = 0,Height = 0)
{
  WinGetPos,X,Y,W,H,A
  Y := 0
  If %Width% = 0
	Width := W

  If %Height% = 0
	Height := H

  WinMove,A,,%X%,%Y%,%Width%,%Height%
}

GoToPage(pageURL)
{
coopHomeCycles := 0
resultScreenCycles := 0	
battleNonActions := 0
	
Sleep, default_interval
Send, ^l 
Sleep, 100
Clipboard := pageURL
Sleep, 100
Send, ^v
Sleep, 100
Send, {ENTER}
Sleep, default_interval
Return
}

RandomClick(coordX, coordY, variance)
{
	Random, randX, 0 - variance, variance
	Random, randY, 0 - variance, variance
	
	updateLog("Random coordinate modifiers: " . randX . ", " . randY)
	
	MouseMove coordX + randX, coordY + randY
	Click
}

RandomClickWide(coordX, coordY, variance)
{
	Random, randX, 0 - (variance*2), (variance*2)
	Random, randY, 0 - variance, variance
	
	updateLog("Random coordinate modifiers: " . randX . ", " . randY)
	
	MouseMove coordX + randX, coordY + randY
	Click
}

ClickSkill(character, skillNum)
{
	offset1 := (character - 1) * skillCharOffset
	offset2 := (skillNum - 1) * skillXOffset
	
	skillCoordX := skillX + offset1 + offset2
	
	updateLog("Clicking skill: " . character . "," . skillNum . " at " . skillCoordX . "," . skillY)
	
	RandomClick(skillCoordX, skillY, clickVarianceSmall)
	Sleep, % default_button_delay
}

FindElementInArray(ByRef foundIndex, inputArray, findThis)
{
	for index, element in inputArray
	{
		if InStr(element, findThis)
		{
			foundIndex := index
			return foundIndex
		}
	}
	return null
}

;----------------------------------------------
;Browser URL Tools
;----------------------------------------------

GetActiveChromeURL(){
	global ChromeBrowsers
	WinGetClass, sClass, A
	If sClass In % ChromeBrowsers
		Return GetBrowserURL_ACC(sClass)
	Else
		Return ""
}
 
GetActiveBrowserURL() {
	global ModernBrowsers, LegacyBrowsers
	WinGetClass, sClass, A
	If sClass In % ModernBrowsers
		Return GetBrowserURL_ACC(sClass)
	Else If sClass In % LegacyBrowsers
		Return GetBrowserURL_DDE(sClass) ; empty string if DDE not supported (or not a browser)
	Else
		Return ""
}
 
; "GetBrowserURL_DDE" adapted from DDE code by Sean, (AHK_L version by maraskan_user)
; Found at http://autohotkey.com/board/topic/17633-/?p=434518
 
GetBrowserURL_DDE(sClass) {
	WinGet, sServer, ProcessName, % "ahk_class " sClass
	StringTrimRight, sServer, sServer, 4
	iCodePage := A_IsUnicode ? 0x04B0 : 0x03EC ; 0x04B0 = CP_WINUNICODE, 0x03EC = CP_WINANSI
	DllCall("DdeInitialize", "UPtrP", idInst, "Uint", 0, "Uint", 0, "Uint", 0)
	hServer := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", sServer, "int", iCodePage)
	hTopic := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", "WWW_GetWindowInfo", "int", iCodePage)
	hItem := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", "0xFFFFFFFF", "int", iCodePage)
	hConv := DllCall("DdeConnect", "UPtr", idInst, "UPtr", hServer, "UPtr", hTopic, "Uint", 0)
	hData := DllCall("DdeClientTransaction", "Uint", 0, "Uint", 0, "UPtr", hConv, "UPtr", hItem, "UInt", 1, "Uint", 0x20B0, "Uint", 10000, "UPtrP", nResult) ; 0x20B0 = XTYP_REQUEST, 10000 = 10s timeout
	sData := DllCall("DdeAccessData", "Uint", hData, "Uint", 0, "Str")
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hServer)
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hTopic)
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hItem)
	DllCall("DdeUnaccessData", "UPtr", hData)
	DllCall("DdeFreeDataHandle", "UPtr", hData)
	DllCall("DdeDisconnect", "UPtr", hConv)
	DllCall("DdeUninitialize", "UPtr", idInst)
	csvWindowInfo := StrGet(&sData, "CP0")
	StringSplit, sWindowInfo, csvWindowInfo, `" ;"; comment to avoid a syntax highlighting issue in autohotkey.com/boards
	Return sWindowInfo2
}
 
GetBrowserURL_ACC(sClass) {
	global nWindow, accAddressBar
	If (nWindow != WinExist("ahk_class " sClass)) ; reuses accAddressBar if it's the same window
	{
		nWindow := WinExist("ahk_class " sClass)
		accAddressBar := GetAddressBar(Acc_ObjectFromWindow(nWindow))
	}
	Try sURL := accAddressBar.accValue(0)
	If (sURL == "") {
		WinGet, nWindows, List, % "ahk_class " sClass ; In case of a nested browser window as in the old CoolNovo (TO DO: check if still needed)
		If (nWindows > 1) {
			accAddressBar := GetAddressBar(Acc_ObjectFromWindow(nWindows2))
			Try sURL := accAddressBar.accValue(0)
		}
	}
	If ((sURL != "") and (SubStr(sURL, 1, 4) != "http")) ; Modern browsers omit "http://"
		sURL := "http://" sURL
	If (sURL == "")
		nWindow := -1 ; Don't remember the window if there is no URL
	Return sURL
}
 
; "GetAddressBar" based in code by uname
; Found at http://autohotkey.com/board/topic/103178-/?p=637687
 
GetAddressBar(accObj) {
	Try If ((accObj.accRole(0) == 42) and IsURL(accObj.accValue(0)))
		Return accObj
	Try If ((accObj.accRole(0) == 42) and IsURL("http://" accObj.accValue(0))) ; Modern browsers omit "http://"
		Return accObj
	For nChild, accChild in Acc_Children(accObj)
		If IsObject(accAddressBar := GetAddressBar(accChild))
			Return accAddressBar
}
 
IsURL(sURL) {
	Return RegExMatch(sURL, "^(?<Protocol>https?|ftp)://(?<Domain>(?:[\w-]+\.)+\w\w+)(?::(?<Port>\d+))?/?(?<Path>(?:[^:/?# ]*/?)+)(?:\?(?<Query>[^#]+)?)?(?:\#(?<Hash>.+)?)?$")
}
 
; The code below is part of the Acc.ahk Standard Library by Sean (updated by jethrow)
; Found at http://autohotkey.com/board/topic/77303-/?p=491516
 
Acc_Init()
{
	static h
	If Not h
		h:=DllCall("LoadLibrary","Str","oleacc","Ptr")
}
Acc_ObjectFromWindow(hWnd, idObject = 0)
{
	Acc_Init()
	If DllCall("oleacc\AccessibleObjectFromWindow", "Ptr", hWnd, "UInt", idObject&=0xFFFFFFFF, "Ptr", -VarSetCapacity(IID,16)+NumPut(idObject==0xFFFFFFF0?0x46000000000000C0:0x719B3800AA000C81,NumPut(idObject==0xFFFFFFF0?0x0000000000020400:0x11CF3C3D618736E0,IID,"Int64"),"Int64"), "Ptr*", pacc)=0
	Return ComObjEnwrap(9,pacc,1)
}
Acc_Query(Acc) {
	Try Return ComObj(9, ComObjQuery(Acc,"{618736e0-3c3d-11cf-810c-00aa00389b71}"), 1)
}
Acc_Children(Acc) {
	If ComObjType(Acc,"Name") != "IAccessible"
		ErrorLevel := "Invalid IAccessible Object"
	Else {
		Acc_Init(), cChildren:=Acc.accChildCount, Children:=[]
		If DllCall("oleacc\AccessibleChildren", "Ptr",ComObjValue(Acc), "Int",0, "Int",cChildren, "Ptr",VarSetCapacity(varChildren,cChildren*(8+2*A_PtrSize),0)*0+&varChildren, "Int*",cChildren)=0 {
			Loop %cChildren%
				i:=(A_Index-1)*(A_PtrSize*2+8)+8, child:=NumGet(varChildren,i), Children.Insert(NumGet(varChildren,i-8)=9?Acc_Query(child):child), NumGet(varChildren,i-8)=9?ObjRelease(child):
			Return Children.MaxIndex()?Children:
		} Else
			ErrorLevel := "AccessibleChildren DllCall Failed"
	}
}